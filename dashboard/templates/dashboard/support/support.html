{% extends "dashboard/gabarit.html" %}
{% load static thumbnail i18n widget_tweaks countries %}
{% block content  %}
<div class="container-xxl flex-grow-1 container-p-y">

    <div class="row g-4 mb-4">
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="content-left">
                        <span>Tous les Tickets</span>
                        <div class="d-flex align-items-end mt-2">
                            <h4 class="mb-0 me-2">{{ countticket }}</h4>
                        </div>
                        <small>Total</small>
                        </div>
                        <span class="badge bg-label-primary rounded p-2">
                        <i class="bx bx-news bx-sm"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="content-left">
                        <span>Tickets En attente de résolution</span>
                        <div class="d-flex align-items-end mt-2">
                            <h4 class="mb-0 me-2">{{ countticketpending }}</h4>
                        </div>
                        <small>Total </small>
                        </div>
                        <span class="badge bg-label-danger rounded p-2">
                        <i class="bx bx-time bx-sm"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between">
                        <div class="content-left">
                        <span>Tickets Résolus</span>
                        <div class="d-flex align-items-end mt-2">
                            <h4 class="mb-0 me-2">{{ countticketclose }}</h4>
                        </div>
                        <small>Total</small>
                        </div>
                        <span class="badge bg-label-success rounded p-2">
                        <i class="bx bx-calendar-check bx-sm"></i>
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-xl-3">
            <div class="card">
                <div class="card-body">
                <div class="d-flex align-items-start justify-content-between">
                    <div class="content-left">
                    <span>Tickets En attente de l'utilisateur</span>
                    <div class="d-flex align-items-end mt-2">
                        <h4 class="mb-0 me-2">{{ countpendingcustomer }}</h4>
                    </div>
                    <small>Total</small>
                    </div>
                    <span class="badge bg-label-warning rounded p-2">
                    <i class="bx bx-time bx-sm"></i>
                    </span>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Blog List Table -->
    <div class="card">
        <div id="ticketlistbloc">
            <div class="card-header border-bottom row">
                <h5 class="card-title col-lg-10">Liste des Tickets</h5>
                <div class="col-lg-2 searchpage">
                    <input class="form-control" id="searchsupportticket" type="text" placeholder="Recherche..">
                </div>
            </div> 
            
            <!-- Main content -->
            <div class="card-body">
                <table id="filtersupportticket" class="table shadow-card">
                    <thead>
                        <tr>
                            <th>Profil</th>
                            <th>Nom</th>
                            <th>Résumé de la requête</th>
                            <th>Service</th>
                            <th>Commandes</th>
                            <th>Etat de la requête</th>
                            <th>Résolue</th>
                            <th>Plus ></th>
                        </tr>
                    </thead>    
                    <tbody>
                        {% if allticket %}
                            {% for item in allticket %}
                                <tr>
                                    <td>
                                        {% if item.owner_pp  %}
                                            {% thumbnail item.owner_pp '200x200' as im %}
                                            <img src="{{ im.url }}" class='img-circle elevation-2 supportpp'/>
                                        {% else %}
                                            <img src="{% static 'backend/img/avatars/avatar.png' %}" class='img-circle elevation-2 supportpp'/>
                                        {% endif %}
                                    </td>
                                    <td>{{item.owner_name}}</td>
                                    <td>{{item.resume}}</td>
                                    <td>{{item.service}}</td>
                                    <td>
                                        {% if item.command == '' %}
                                            <div class="activelistitem">Aucune Commande Rattachée</div>
                                        {% else %}
                                            <div class="activelistitem">{{ item.command }}</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.progression_status == 0 %}
                                            <div class="activelistitem">En attente du support</div>
                                        {% elif item.progression_status == 1 %}
                                            <div class="activelistitem">En attente de l'utilisateur</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.is_resolv %}
                                            <div class="activelistitem">Requête Résolue</div>
                                        {% else %}
                                            <div class="activelistitem">Requête Non Résolue</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="dropdown ticketoptionblock">
                                            <button class="btn" 
                                                url="{% url 'dashboard:message-ticket-support' %}"  
                                                deletemessageurl="{% url 'dashboard:delete-message-ticket-support' %}" 
                                                ticket="{{ item.id }}" 
                                                token="{{ csrf_token }}"
                                                onclick="openTicketChat(this)">
                                                <i class="fa fa-chevron-circle-right"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr >
                                <td colspan="7" class="text-primary text-center" >
                                    <p class="emptylist">Aucune Ticket n'a été enregistré!</p>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            <!-- /.content --> 
        </div>


        <!-- Ticket contain start -->
        <div class="card-body" id="ticketcontain">
            <div class="headerchatticket">
                <div class="row">
                    <button class="backticketlist col-lg-2" onclick="closeTicketChat(this)"><i class="fa fa-home"></i></button>
                    <div class="ticketnumber col-lg-5">Ticket : Nº <span id="numberticket"></span></div>
                    <div class="ticketnumber col-lg-5">Status : <span id="statusticket"></span></div>
                </div>
                <hr>
                <div class="row">
                    <div class="ticketnumber col-lg-6">Service </div>
                    <div class="ticketnumber col-lg-6" id="serviceticket"></div>
                </div>
                <hr>
                <div class="row">
                    <div class="ticketnumber col-lg-6">Résumé </div>
                    <div class="ticketnumber col-lg-6" id="resumeticket"></div>
                </div>
            </div>
            <hr>

            <div id="blockchatticket">
                <div id="chatticketexchange">
                
                </div>

                <div class="blockinputmessage">
                    <form class="row createTicketMessageSubmit" enctype="multipart/form-data" action="{% url 'dashboard:create-message-ticket-support' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="owner" value="{{ current_person.id }}">
                        <input type="hidden" name="ticket" id="ticketid">
                        <div class="inputtextticket col-lg-10">
                            <textarea name="message" id="chattextbox"></textarea>
                        </div>
                        <div class="containerbtnticketsend col-lg-2">
                            <button class="btnsendticket createbtnticketmessage">Envoyer <i class="fa fa-paper-plane"></i></button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <!-- Ticket Contain End -->
    </div>

</div>
{% endblock content  %}